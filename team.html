<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Page • Cornhole League Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(2,6,23,.55);
      --panel2: rgba(2,6,23,.35);
      --border: rgba(148,163,184,.14);
      --text:#e2e8f0;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --danger:#f97316;
      --good:#22c55e;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0%, #020617 60%);
      color:var(--text);
      min-height:100vh;
      padding: 18px;
    }
    .wrap{max-width: 980px; margin: 0 auto;}
    h1{
      margin: 6px 0 8px;
      letter-spacing:.02em;
      font-weight: 950;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 14px 16px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      margin-top: 12px;
    }
    .subtle{
      background: rgba(2,6,23,.25);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: 14px;
      padding: 12px;
    }
    .tiny{font-size:.78rem;color:var(--muted)}
    .muted{color:var(--muted)}
    label{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.03em;
      color:var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input, select, textarea{
      width:100%;
      background: rgba(15,23,42,.45);
      border: 1px solid rgba(148,163,184,.22);
      border-radius: 12px;
      padding: 10px 10px;
      color: var(--text);
      outline:none;
      font-size: .92rem;
    }
    textarea{resize:vertical; min-height: 100px;}
    input:focus, select:focus, textarea:focus{border-color: var(--accent)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .row1{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px}
    @media (max-width: 900px){
      .row{grid-template-columns:1fr}
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{
      border:none;border-radius:12px;padding:10px 12px;
      font-weight: 950; cursor:pointer;
      background: var(--accent); color:#06121d;
    }
    button.secondary{
      background: rgba(148,163,184,.16);
      color: var(--text);
      border: 1px solid rgba(148,163,184,.22);
    }
    button.danger{
      background: rgba(249,115,22,.14);
      color: var(--text);
      border: 1px solid rgba(249,115,22,.45);
    }
    button:disabled{opacity:.45;cursor:not-allowed}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.22);
      color: var(--text);
      font-size: .78rem;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good)}
    .dot.bad{background: var(--danger)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .divider{height:1px;background: rgba(148,163,184,.10);margin: 10px 0}
    .badge{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size:.72rem;
      font-weight: 950;
      border: 1px solid rgba(56,189,248,.28);
      background: rgba(56,189,248,.12);
      margin-right: 6px;
      white-space:nowrap;
    }
    code{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="actions" style="justify-content:space-between;align-items:center;gap:10px;">
      <div class="actions" style="gap:10px;">
        <a href="./index.html" class="pill">← Back to Tracker</a>
        <span class="pill"><span id="apiDot" class="dot"></span><span id="apiStatus">ok</span></span>
      </div>
      <div class="actions">
        <button id="reloadBtn" class="secondary" type="button">Reload</button>
        <button id="signOutBtn" class="secondary" type="button" style="display:none;">Sign Out</button>
      </div>
    </div>

    <h1>
      Team Page
      <span class="pill"><span class="muted">ID:</span> <span id="teamIdLabel">—</span></span>
      <span class="pill"><span class="muted">Edit:</span> <span id="editLabel">—</span></span>
    </h1>

    <div class="card">
      <div class="subtle" id="authBlock">
        <div style="font-weight:950;margin-bottom:6px;">Sign in (to edit, if you’re on this team)</div>
        <div class="tiny" style="margin-bottom:10px;">
          Viewing works without signing in. Editing requires signing in as a team member.
        </div>

        <div class="row">
          <div>
            <label for="playerSelect">Player</label>
            <select id="playerSelect"></select>
          </div>
          <div>
            <label for="pinInput">PIN</label>
            <input id="pinInput" type="password" inputmode="numeric" placeholder="Enter your PIN" />
          </div>
        </div>

        <div class="actions">
          <button id="unlockBtn" type="button">Unlock</button>
          <span class="tiny" id="authStatus">Not signed in.</span>
        </div>
      </div>

      <div class="divider"></div>

      <div id="teamView">
        <div class="row">
          <div>
            <div style="font-weight:950;margin-bottom:6px;">Team</div>
            <div class="tiny" id="teamNameDisplay">—</div>
            <div class="tiny" id="teamMembersDisplay">—</div>
          </div>
          <div>
            <div style="font-weight:950;margin-bottom:6px;">Quick Links</div>
            <div class="tiny">
              <a id="openTeamLink" href="#" target="_blank">Open this page (share)</a>
            </div>
            <div class="tiny" style="margin-top:6px;">
              <a id="openMatchesLink" href="./index.html">Open Tracker</a>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div style="font-weight:950;margin-bottom:8px;">Team Info</div>

        <div class="row">
          <div>
            <label for="teamNameInput">Team Name</label>
            <input id="teamNameInput" placeholder="e.g. Bag Bandits" />
          </div>
          <div>
            <label for="teamColorInput">Color (optional)</label>
            <input id="teamColorInput" placeholder="e.g. #38bdf8" />
            <div class="tiny">This is optional and purely cosmetic.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="homeCourtInput">Home Court (optional)</label>
            <input id="homeCourtInput" placeholder="Backyard, League Night..." />
          </div>
          <div>
            <label>Permissions</label>
            <div class="tiny" id="permHint" style="padding-top:10px;">—</div>
          </div>
        </div>

        <div class="row1">
          <div>
            <label for="bioInput">Bio / Notes</label>
            <textarea id="bioInput" placeholder="Add any team notes, stats, rivalries, etc..."></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="saveBtn" type="button">Save Team Info</button>
          <button id="resetBtn" type="button" class="secondary">Reset</button>
        </div>

        <div class="tiny" id="saveStatus" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- CONFIG ----------------
    const API = "https://solitary-moon-7578.michaelamarino16.workers.dev";
    const LS_TOKEN = "ct_device_token_v3";
    const LS_PLAYER = "ct_player_v3";

    // ---------------- STATE ----------------
    let playersCache = [];
    let teamId = "";
    let teamCache = null;

    // ---------------- DOM helpers ----------------
    const $ = (id) => document.getElementById(id);

    function keyName(name){ return (name || "").trim().toLowerCase(); }

    function getSession(){
      const token = localStorage.getItem(LS_TOKEN) || "";
      let player = null;
      try { player = JSON.parse(localStorage.getItem(LS_PLAYER) || "null"); } catch {}
      return { token, player };
    }

    function setSession(token, player){
      localStorage.setItem(LS_TOKEN, token);
      localStorage.setItem(LS_PLAYER, JSON.stringify(player));
      updateAuthUI();
    }

    function clearSession(){
      localStorage.removeItem(LS_TOKEN);
      localStorage.removeItem(LS_PLAYER);
      updateAuthUI();
    }

    function isSignedIn(){
      const s = getSession();
      return !!(s.token && s.player && s.player.key);
    }

    async function api(path, opts = {}){
      const { token } = getSession();
      const headers = { "Content-Type": "application/json", ...(opts.headers || {}) };
      if (token) headers["Authorization"] = `Bearer ${token}`;
      const res = await fetch(`${API}${path}`, { ...opts, headers });

      const ct = res.headers.get("content-type") || "";
      const isJson = ct.includes("application/json");
      const data = isJson ? await res.json() : await res.text();

      if (!res.ok){
        const msg = (data && data.error) ? data.error : (typeof data === "string" ? data : `HTTP ${res.status}`);
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }
      return data;
    }

    function setApiStatus(ok, msg){
      $("apiStatus").textContent = msg;
      $("apiDot").classList.toggle("bad", !ok);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function playerNameByKey(k){
      const p = playersCache.find(x => x.key === k);
      return p ? p.name : k;
    }

    function membersLabel(keys){
      const names = (keys || []).map(playerNameByKey).filter(Boolean);
      names.sort((a,b)=>a.localeCompare(b));
      return names.join(" + ");
    }

    function canEditTeam(){
      if (!teamCache) return false;
      const s = getSession();
      const myKey = s.player?.key || "";
      return Array.isArray(teamCache.members) && teamCache.members.includes(myKey);
    }

    // ---------------- LOADERS ----------------
    async function loadPlayers(){
      const data = await api("/players", { method: "GET" });
      playersCache = data.players || [];
      return playersCache;
    }

    async function loadTeam(){
      if (!teamId) throw new Error("Missing team id");
      const data = await api(`/teams/${encodeURIComponent(teamId)}`, { method: "GET" });
      teamCache = data.team;
      return teamCache;
    }

    // ---------------- RENDER ----------------
    async function renderPlayerSelect(){
      const sel = $("playerSelect");
      sel.innerHTML = "";
      if (!playersCache.length){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No players yet";
        sel.appendChild(opt);
        return;
      }
      for (const p of playersCache){
        const opt = document.createElement("option");
        opt.value = p.key;
        opt.textContent = `${p.name}${p.isAdmin ? " (Admin)" : ""}`;
        sel.appendChild(opt);
      }
      const s = getSession();
      if (s.player?.key && playersCache.some(p => p.key === s.player.key)){
        sel.value = s.player.key;
      } else {
        sel.selectedIndex = 0;
      }
    }

    function updateAuthUI(){
      const { token, player } = getSession();
      const signedIn = !!(token && player);

      $("signOutBtn").style.display = signedIn ? "inline-block" : "none";
      $("pinInput").disabled = signedIn;
      $("unlockBtn").disabled = signedIn;

      $("authStatus").textContent = signedIn
        ? `Signed in as ${player.name}${player.isAdmin ? " (Admin)" : ""}.`
        : "Not signed in.";

      // update edit controls based on membership
      const editable = canEditTeam();
      $("editLabel").textContent = editable ? "Allowed" : "View only";
      $("permHint").textContent = editable
        ? "You are on this team. You can edit and save changes."
        : "Only team members can edit team info.";

      $("teamNameInput").disabled = !editable;
      $("teamColorInput").disabled = !editable;
      $("homeCourtInput").disabled = !editable;
      $("bioInput").disabled = !editable;
      $("saveBtn").disabled = !editable;
    }

    function renderTeam(){
      $("teamIdLabel").textContent = teamId || "—";

      if (!teamCache){
        $("teamNameDisplay").textContent = "Team not found.";
        $("teamMembersDisplay").textContent = "";
        return;
      }

      const memberNames = membersLabel(teamCache.members || []);
      const displayName = teamCache.name || memberNames || "Team";

      $("teamNameDisplay").innerHTML =
        `<span class="badge">Name</span> <span style="font-weight:950;">${escapeHtml(displayName)}</span>`;

      $("teamMembersDisplay").innerHTML =
        `<span class="badge" style="margin-top:6px;">Members</span> ${escapeHtml(memberNames || "—")}`;

      $("openTeamLink").href = `./team.html?id=${encodeURIComponent(teamId)}`;

      // populate form fields (even if readonly)
      $("teamNameInput").value = teamCache.name || "";
      $("teamColorInput").value = teamCache.color || "";
      $("homeCourtInput").value = teamCache.homeCourt || "";
      $("bioInput").value = teamCache.bio || "";

      updateAuthUI();
    }

    // ---------------- ACTIONS ----------------
    async function unlock(){
      const selKey = $("playerSelect").value;
      const pin = ($("pinInput").value || "").trim();
      if (!selKey){ alert("Pick a player."); return; }
      if (!pin){ alert("Enter your PIN."); return; }

      const picked = playersCache.find(p => p.key === selKey);
      if (!picked){ alert("Player not found."); return; }

      try{
        const data = await api("/auth/pin", {
          method: "POST",
          body: JSON.stringify({ name: picked.name, pin })
        });
        setSession(data.token, data.player);
        $("pinInput").value = "";
        await refreshAll(false);
        alert("Unlocked!");
      } catch(e){
        alert("Unlock failed: " + e.message);
      }
    }

    async function saveTeam(){
      if (!canEditTeam()){
        alert("Only team members can edit this team.");
        return;
      }

      const payload = {
        name: ($("teamNameInput").value || "").trim(),
        color: ($("teamColorInput").value || "").trim(),
        homeCourt: ($("homeCourtInput").value || "").trim(),
        bio: ($("bioInput").value || "").trim()
      };

      if (!payload.name){
        alert("Team name cannot be blank.");
        return;
      }

      $("saveStatus").textContent = "Saving...";
      try{
        const data = await api(`/teams/${encodeURIComponent(teamId)}`, {
          method: "PUT",
          body: JSON.stringify(payload)
        });
        teamCache = data.team;
        $("saveStatus").textContent = "Saved ✅";
        renderTeam();
      } catch(e){
        $("saveStatus").textContent = "Save failed ❌";
        alert("Save failed: " + e.message);
      }
    }

    function resetForm(){
      if (!teamCache) return;
      $("teamNameInput").value = teamCache.name || "";
      $("teamColorInput").value = teamCache.color || "";
      $("homeCourtInput").value = teamCache.homeCourt || "";
      $("bioInput").value = teamCache.bio || "";
      $("saveStatus").textContent = "";
    }

    // ---------------- REFRESH ----------------
    async function refreshAll(showAlert){
      try{
        await loadPlayers();
        await renderPlayerSelect();
        await loadTeam();
        renderTeam();
        setApiStatus(true, "ok");
        if (showAlert) alert("Reloaded.");
      } catch(e){
        setApiStatus(false, "error");
        if (showAlert) alert("Reload failed: " + e.message);
      }
    }

    // ---------------- INIT ----------------
    document.addEventListener("DOMContentLoaded", async ()=>{
      const url = new URL(window.location.href);
      teamId = (url.searchParams.get("id") || "").trim();

      $("teamIdLabel").textContent = teamId || "—";
      $("openTeamLink").href = `./team.html?id=${encodeURIComponent(teamId || "")}`;

      $("reloadBtn").addEventListener("click", ()=>refreshAll(true));
      $("unlockBtn").addEventListener("click", unlock);
      $("saveBtn").addEventListener("click", saveTeam);
      $("resetBtn").addEventListener("click", resetForm);

      $("signOutBtn").addEventListener("click", async ()=>{
        clearSession();
        await refreshAll(false);
      });

      // If no id provided, show a friendly message
      if (!teamId){
        setApiStatus(false, "missing id");
        $("editLabel").textContent = "—";
        $("teamNameDisplay").textContent = "Missing team id. Use team.html?id=TEAM_ID";
        $("teamMembersDisplay").textContent = "";
        $("teamView").style.display = "none";
        return;
      }

      updateAuthUI();
      await refreshAll(false);
    });
  </script>
</body>
</html>
